{% extends "layout.html" %}

{% block title %}
US Travel Map
{% endblock %}

{% block style %}
    body {font-family: Arial, Helvetica, sans-serif;}

    /* The Modal (background) */
    .modal {
    display: none; /* Hidden by default */
    position: fixed; /* Stay in place */
    z-index: 1; /* Sit on top */
    padding-top: 100px; /* Location of the box */
    left: 0;
    top: 0;
    width: 100%; /* Full width */
    height: 100%; /* Full height */
    overflow: auto; /* Enable scroll if needed */
    background-color: rgb(0,0,0); /* Fallback color */
    background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
    }

    /* Modal Content */
    .modal-content {
    position: relative;
    background-color: #fefefe;
    margin: auto;
    padding: 0;
    border: 1px solid #888;
    width: 80%;
    box-shadow: 0 4px 8px 0 rgba(0,0,0,0.2),0 6px 20px 0 rgba(0,0,0,0.19);
    -webkit-animation-name: animatetop;
    -webkit-animation-duration: 0.4s;
    animation-name: animatetop;
    animation-duration: 0.4s
    }

    /* Add Animation */
    @-webkit-keyframes animatetop {
    from {top:-300px; opacity:0} 
    to {top:0; opacity:1}
    }

    @keyframes animatetop {
    from {top:-300px; opacity:0}
    to {top:0; opacity:1}
    }

    /* The Close Button */
    .close {
    color: white;
    float: right;
    font-size: 28px;
    font-weight: bold;
    }

    .close:hover,
    .close:focus {
    color: #000;
    text-decoration: none;
    cursor: pointer;
    }

    .modal-header {
    padding: 2px 16px;
    background-color: #5cb85c;
    color: white;
    }

    .modal-body {
        padding: 2px 16px;
        display: flex;
        flex-direction: row;
        flex-wrap: wrap;
    }

    .modal-footer {
    padding: 2px 16px;
    background-color: #5cb85c;
    color: white;
    } 
{% endblock %}

{% block main %}
<p>
    This map can be used to track which states you've visited. Just click on a state to change it's color and indicate that you've been there. 
    If you make a mistake, just click on the state again to unmark it as a state you've visited. This information is stored on the website's database and is 
    linked to your user account. This way all of your progress is saved and next time you come back to this site you can pick up where you left off.

</p>
<!-- USING SVG FOR WEB APPS REFERENCES: --
    https://svgontheweb.com/
    https://www.sitepoint.com/add-svg-to-web-page/
    http://www.petercollingridge.co.uk/tutorials/svg/interactive/javascript/
-->
<object id="svg-map-object" type="image/svg+xml" data="{{url_for('static', filename='images/Map_US_States.svg') }}">
    <!-- Within the object tags you can add fallback text or images in case the web browser doesn't support the 'object' type. -->
    Your browser does not support SVG.
</object>

<div id="stateModal" class="modal">
    <!-- Modal content -->
    <div class="modal-content">
        <div class="modal-header">
            <h2 class="stateName"></h2>
            <span class="close">&times;</span>
        </div>
        <div class="modal-body">
            <div class="modal-state-info" style="flex: 1 1 200px">
                <div class="modal-state-outline" style="border-style: solid; border-width: 2px; border-color: red;">
                    <svg id="stateSvg" height="200" width="200" viewBox="0 0 200 200">
                        <path  d="" />
                        Sorry, your browser does not support inline SVG.
                      </svg>
                </div>
                <div class="modal-state-text" style="border-style: solid; border-width: 2px; border-color: red;">
                    <p>
                        Here will be some fun information about the state shown above. The following text is sample text and serves no purpose at all. 
                        This manual is not an employment contract and does not guarnatee the sontinuation of any benefits or employment for any specific duration. 
                        Although we hop that your emplyoment relationship with us will be fulfilling and long-lasting. Either the employee or busines may terminate 
                        this relationship at any time.

                    </p>
                </div>
            </div>
            <div class="modal-state-photos" style="flex: 3 3 500px; border-style: solid; border-width: 2px; border-color: red;">
                <p> modal state photos</p>
            </div>
        </div>
        <div class="modal-footer">
            <h3>Modal Footer</h3>
        </div>
    </div>
</div>

{% endblock %}

{% block afterbody %}
    <script type="text/javascript">
        // https://flask.palletsprojects.com/en/1.1.x/patterns/jquery/#where-is-my-site
        $SCRIPT_ROOT = {{ request.script_root|tojson|safe }};

        // Get the modal object and the object for closing the modal
        var stateModal = document.getElementById("stateModal");
        var closeModal = document.getElementsByClassName("close")[0];

        // When the user clicks on the icon to close the modal then close it.
        closeModal.addEventListener('click', function(event){
            stateModal.style.display = "none";
        });
        stateModal.addEventListener('click', function(event){
            // If the user clicked outside the modal, then close it.
            // Note: when the event target is "stateModel" it is considered outside the modal. Otherwise, the target will be something like "modal-content".
            console.log(event.target.id);
            if (event.target.id == "stateModal"){
                stateModal.style.display = "none";
            }

            // TODO: Other events when user clicks inside the modal...

        });

        ///
        /// Request information about the state that was clicked on.
        ///
        function queryStateInfo(stateId){
            var xhttp = new XMLHttpRequest();
            xhttp.onreadystatechange = function() {
                if (this.readyState == 4 && this.status == 200) {
                    populateStateModal(this);
                }
            };
            xhttp.open("GET", {{ url_for('main.queryStateInfo')|tojson }} + "?" + "stateId=" + stateId, true);
            xhttp.responseType = 'json';
            xhttp.send();
        }

        ///
        /// Populate the information in the State modal based on response from server.
        ///
        function populateStateModal(xhttp){
            const stateJsonObj = xhttp.response;
            // Populate the state name anywhere it is posted in the modal
            for (element of stateModal.getElementsByClassName("stateName")){
                element.innerHTML = stateJsonObj['StateName'];
            }

            // Extract path data from US map SVG for the specific state of interest.
            let mapSvgObj= document.getElementById('svg-map-object').contentDocument;
            let stateSvgPath = mapSvgObj.getElementById(stateJsonObj['StateAbreviation']).getAttribute("d");

            // Change the SVG in the modal to match the state of interest.
            let stateSvg = document.getElementById("stateSvg");
            stateSvg.getElementsByTagName("path")[0].setAttribute("d", stateSvgPath);
            stateSvg.getElementsByTagName("path")[0].style.fill='green';

            // Adjust the state SVG image so that it is centered
            let bboxRect = stateSvg.getBBox();
            let updatedViewBox = bboxRect['x'] + " " + bboxRect['y'] + " " + bboxRect['width'] + " " + bboxRect['height'];
            stateSvg.setAttribute("viewBox", updatedViewBox);

            // Populate the state text and information in the modal.
            let randomText = "Here will be some fun information about the state shown above. The following text is sample text and serves no purpose at all. This manual is not an employment contract and does not guarnatee the sontinuation of any benefits or employment for any specific duration. Although we hop that your emplyoment relationship with us will be fulfilling and long-lasting. Either the employee or busines may terminate this relationship at any time.";
            if (stateJsonObj['StateVisited']) {
                stateModal.getElementsByClassName("modal-state-text")[0].innerHTML = "\n\n You have visited " + stateJsonObj['StateName'] + ".\n\n" + randomText;
            }
            else {
                stateModal.getElementsByClassName("modal-state-text")[0].innerHTML = "You have not visited " + stateJsonObj['StateName'] + ".\n\n" + randomText;
            }
            
        }

        ///
        /// When page is loaded, setup and create the SVG map.
        ///
        window.addEventListener("load", function() {
            // Load map for current user
            loadUsersMap();

            var svgObject = document.getElementById('svg-map-object').contentDocument;
            // Add event listener to send data to web server when a state in the SVG is clicked on.
            svgObject.addEventListener('click', function (event){
                if(event.target.hasAttribute('id')){
                    var stateId = event.target.getAttribute('id');
                    console.log(stateId);
                    
                    // First populate the data for the modal
                    queryStateInfo(stateId);
                    
                    // Show the modal
                    stateModal.style.display = "block";

                    // OLD CODE: THIS FUNCTIONALITY WILL BE REPLACED INSIDE MODAL
                    // Send stateId from click event to server to update database of states visited.
                    //postMapUpdates(stateId);
                }
            })

        });

        ///
        /// Load and update the map for the current user's settings
        ///
        function loadUsersMap(){
            var xhttp = new XMLHttpRequest();
            xhttp.onreadystatechange = function() {
                if (this.readyState == 4 && this.status == 200) {
                    recolorMap(this);
                }
            };
            xhttp.open("GET", {{ url_for('main.updateMap')|tojson }}, true);
            xhttp.send();
        }

        ///
        /// Recolor the SVG map per the states listed in the xhttp response
        ///
        function recolorMap(xhttp){
            var stateList = JSON.parse(xhttp.responseText)
            var svgObject = document.getElementById('svg-map-object').contentDocument;
            // Reset all of the states to their default grey color.
            for (item of svgObject.getElementsByTagName('path')){
                item.style.fill='#D3D3D3';
            }
            // Loop through states which this user has visited and color them blue.
            for (stateId of stateList){
                svgObject.getElementById(stateId).style.fill='blue';
            }
            
        }

        ///
        /// Sends a POST request to the server to add the state that was clicked on.
        ///
        function postMapUpdates(stateId){
            var xhttp = new XMLHttpRequest();
            xhttp.onreadystatechange = function() {
                if (this.readyState == 4 && this.status == 200) {
                    console.log('we good');
                    loadUsersMap();
                }
            };
            xhttp.open("POST", {{ url_for('main.updateMap')|tojson }}, true);
            xhttp.setRequestHeader("Content-type", "application/x-www-form-urlencoded;charset=UTF-8");
            xhttp.send("stateId="+stateId);
        }

    </script>
{% endblock %}